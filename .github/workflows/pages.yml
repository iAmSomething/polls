name: Build and Deploy Dashboard

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Hourly refresh (every hour, UTC)
    - cron: "0 * * * *"
    # Every Monday 09:00 Asia/Seoul == 00:00 UTC Monday
    - cron: "0 0 * * 1"
    # Tuesday 18:00~23:00 Asia/Seoul retry window == 09:00~14:00 UTC Tuesday
    - cron: "0 9-14 * * 2"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: codex_handoff_pack
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-nanum

      - name: Tuesday 18:00 KST NESDC flow (with hourly retries)
        run: |
          python src/tuesday_18kst_runner.py

      - name: Weekly issue intake (Perplexity, optional)
        env:
          PPLX_API_KEY: ${{ secrets.PPLX_API_KEY }}
        run: |
          if [ -z "${PPLX_API_KEY}" ]; then
            echo "PPLX_API_KEY missing. Skip issue intake."
            exit 0
          fi
          WEEK_END=$(TZ=Asia/Seoul date +%F)
          WEEK_START=$(TZ=Asia/Seoul date -d "$WEEK_END -6 days" +%F)
          python src/issue_intake.py \
            --mode llm \
            --llm-provider perplexity \
            --llm-model sonar \
            --week-start "$WEEK_START" \
            --week-end "$WEEK_END" \
            --keywords "정당 지지율,여론조사,민주당,국민의힘,개혁신당,조국혁신당"


      - name: Refresh hourly poll/news inputs
        run: |
          PYTHONPATH=../poll_news_collector python ../poll_news_collector/hourly_pipeline.py \
            --base-dir ../poll_news_collector \
            --project-dir . \
            --window-minutes 60 \
            --run-update \
            --news-json-out docs/news_latest.json \
            --news-limit 6 \
            --max-retries 3 \
            --retry-delay-minutes 60

      - name: Build forecast outputs
        run: |
          python src/pipeline.py
          python src/president_approval_pipeline.py
          python src/president_approval_postprocess.py
          python src/forecast.py --model ssm --regime-guard on --exog-approval on
          python src/backtest_report.py --regime-guard on --exog-approval on
          python src/generate_site.py

      - name: Validate generated news payload
        run: |
          test -f docs/news_latest.json
          test -f docs/index.html
          test -f outputs/president_approval_weekly.csv
          test -f outputs/president_approval_quality_report.csv
          test -f outputs/president_approval_outlier_report.csv
          python - <<'PY'
          import json
          import re
          import pandas as pd
          from pathlib import Path
          p = Path("docs/news_latest.json")
          data = json.loads(p.read_text(encoding="utf-8"))
          assert isinstance(data, list), "news_latest.json must be a list"
          assert len(data) > 0, "news_latest.json must contain at least one row"
          for i, row in enumerate(data[:12]):
            assert isinstance(row, dict), f"row {i} must be an object"
            for k in ("date", "source", "title", "url"):
              assert k in row, f"row {i} missing key: {k}"
          wk = pd.read_csv("outputs/president_approval_weekly.csv")
          required = {"week_monday", "approve", "disapprove", "dk", "n_obs", "total_sample_n"}
          assert required.issubset(set(wk.columns)), "president_approval_weekly.csv schema mismatch"
          html = Path("docs/index.html").read_text(encoding="utf-8")
          m = re.search(r'<script id="poll-data" type="application/json">(.*?)</script>', html, re.S)
          assert m, "poll-data payload missing in docs/index.html"
          payload = json.loads(m.group(1))
          latest = payload.get("latest_poll_results", [])
          assert isinstance(latest, list), "latest_poll_results must be a list"
          if latest:
              for i, row in enumerate(latest):
                  assert isinstance(row, dict), f"latest_poll_results[{i}] must be object"
                  parties = row.get("parties", [])
                  assert isinstance(parties, list), f"latest_poll_results[{i}].parties must be list"
                  names = {str(p.get("party", "")) for p in parties if isinstance(p, dict)}
                  assert "더불어민주당" in names and "국민의힘" in names, f"latest_poll_results[{i}] missing major parties"
          else:
              print("warning: latest_poll_results is empty")
          print("news_latest.json validation ok, rows=", len(data))
          print("latest_poll_results rows=", len(latest))
          PY

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: codex_handoff_pack/docs

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
